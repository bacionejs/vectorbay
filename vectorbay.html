<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>
onload=()=>{
let{PI,round,min}=Math,grid=20,points=[],hi=-1;
function element(tagName,parent=document.body,className=""){let e=document.createElement(tagName);if(className)e.className=className;parent.appendChild(e);return e;}

element("style").textContent=`
body{margin:0;padding:10px;background:#121212;color:#e0e0e0;font-family:sans-serif;display:flex;justify-content:center}
.main{display:flex;flex-direction:column;align-items:center;gap:15px;width:100%;max-width:1000px;position:relative}
@media(orientation:landscape){
  .main{flex-direction:row;align-items:flex-start;height:90vh}
  .c{flex:1;display:flex;flex-direction:column;height:100%}
  .text{height:10em !important;}
}
.canvas{border:1px solid #444;touch-action:none;background:#1e1e1e;border-radius:4px;cursor:crosshair}
.text{width:100%;font-family:monospace;padding:8px;box-sizing:border-box;height:4em;background:#252525;color:#00ff00;border:1px solid #444;outline:none}
.button{width:100%;padding:12px;font-weight:700;margin-top:5px;background:#333;color:#fff;border:1px solid #555;}
.tut{background:#0066cc;border-color:#0088ff}
.hand{position:absolute;font-size:30px;pointer-events:none;transition:left 0.3s ease-out, top 0.3s ease-out, transform 0.1s;display:none;z-index:10}
`;

let main=element("div",document.body,"main");
let hand=element("div",main,"hand");
let text=element("textarea",main,"text");
let canvas=element("canvas",main,"canvas");
let ctrls=element("div",main,"c");
let tut=element("button",ctrls,"button tut");
let save=element("button",ctrls,"button");
let c=canvas.getContext("2d");
hand.textContent="\u{1F446}";
tut.textContent="Tutorial";
save.textContent="Export";

function update() {
let off=grid/2;
let flat=points.map(([x,y])=>[x-off,y-off]).flat().map(v=>round(v));
text.value="["+flat.join(",")+"]";
}

function draw(){
c.clearRect(0,0,canvas.width,canvas.height);
let step=canvas.width/grid,off=grid/2,mid=canvas.width/2;c.strokeStyle="#333";c.beginPath();
for(let i=0;i<=grid;i++){c.moveTo(i*step,0);c.lineTo(i*step,canvas.height);c.moveTo(0,i*step);c.lineTo(canvas.width,i*step)};c.stroke();
c.strokeStyle="#ff4444";c.beginPath();c.moveTo(mid,0);c.lineTo(mid,canvas.height);c.moveTo(0,mid);c.lineTo(canvas.width,mid);c.stroke();
if(points.length>0){
  c.save();c.translate(mid,mid);let p=new Path2D();
  for(let m of [1,-1]){
    p.moveTo(m*(points[0][0]-off)*step,(points[0][1]-off)*step);
    for(let i=1;i<points.length;i++)p.lineTo(m*(points[i][0]-off)*step,(points[i][1]-off)*step);
  }
  let flat=points.map(([x,y])=>[x-off,y-off]).flat().map(v=>round(v));
  if(flat.length>0&&flat[flat.length-2]===0){c.fillStyle="rgba(0, 150, 255, 0.3)";c.fill(p)}
  c.strokeStyle="#00bfff";c.lineWidth=2;c.stroke(p);c.restore()
}
points.forEach(([x,y], i)=>{
  c.beginPath();
  if(i === hi) { c.fillStyle = "#ffff00"; c.arc(x*step, y*step, 7, 0, PI*2); }
  else { c.fillStyle = "#ff4444"; c.arc(x*step, y*step, 4, 0, PI*2); }
  c.fill();
});
};

function highlight() {
let val = text.value, pos = text.selectionStart, regex = /-?\d+/g, match, count = 0; hi = -1; 
while((match=regex.exec(val))!==null){if(pos>=match.index&&pos<=match.index+match[0].length){hi=Math.floor(count/2);break;}count++;}
draw();
}

tut.onclick=()=>{
points=[]; hi=-1;
let off=grid/2; let seq=[]; let raw=[0,-10,2,-1,3,1,3,-2,5,-2,5,2,6,2,10,-1,9,5,3,10,3,7,2,6,2,7,0,7];
for(let i=0;i<raw.length;i+=2)seq.push([raw[i]+off,raw[i+1]+off]);
tut.disabled=true;
hand.style.display="block";
let i=0,step=canvas.width/grid;
let timer=setInterval(()=>{
  if(i>=seq.length){clearInterval(timer);tut.disabled=false;setTimeout(()=>hand.style.display="none",500);return;}
  let pt=seq[i], x=pt[0], y=pt[1];
  hand.style.left=(x*step+canvas.offsetLeft-10)+"px";hand.style.top=(y*step+canvas.offsetTop)+"px";
  setTimeout(()=>{
    hand.style.transform="scale(0.7)";
    points.push(pt); 
    update();
    draw();
    setTimeout(()=>hand.style.transform="scale(1)",100);
  },250);
  i++;
},600);
};

save.onclick=()=>{
let flat=points.map(([x,y])=>[x-grid/2,y-grid/2]).flat().map(v=>round(v));
let closed=flat.length>2 && flat[0]===0 && flat[flat.length-2]===0;
if(!points.length) return alert("No data to export!");
if(!closed) return alert("Shape must start and end on the red center line to close!");
let data=text.value.replace(/[\[\]]/g,"");
let h=`<script>onload=()=>{let c=document.body.appendChild(document.createElement("canvas"));c.width=c.height=400;c.style.border="2px solid silver";let x=c.getContext("2d"),p=[${data}];
function shape(p){let h=new Path2D();for(let m of[1,-1]){h.moveTo(m*p[0],p[1]);for(let j=2;j<p.length;j+=2)h.lineTo(m*p[j],p[j+1]);}return h};x.translate(200,200);x.scale(20,20);
let s=shape(p);x.fillStyle="black";x.fill(s);}<\/script>`,
b=new Blob([h],{type:"text/html"}),a=document.createElement("a");
a.href=URL.createObjectURL(b);a.download="shape.html";a.click();
}

function resize(){let L=innerWidth>innerHeight,s=L?min(innerWidth*.6,innerHeight-40):min(innerWidth-40,innerHeight*.6);canvas.width=canvas.height=s;draw()};

canvas.addEventListener("mousedown",e=>{
let r=canvas.getBoundingClientRect(),s=canvas.width/grid;
points.push([round((e.clientX-r.left)/s),round((e.clientY-r.top)/s)]);
update();
draw();
});

text.addEventListener("click", highlight); text.addEventListener("keyup", highlight); text.addEventListener("input",()=>{
  let n=text.value.match(/-?\d+/g)?.map(Number);
  if(n && n.length % 2 === 0) {
    points=[]; let o=grid/2;
    for(let i=0;i<n.length;i+=2)points.push([n[i]+o,n[i+1]+o]);
  }
  highlight();
});

addEventListener("resize",resize);resize()};
</script>
